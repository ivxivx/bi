function Category(e,r,t,n){var a={version:"0.1.0",type:"Category",name:e,alias:r,aggregate:t,expression:n,display:t?t+"("+e+")":e},i={};return a.values=function(e){return arguments.length?(i=e,a):i},a}function Series(e,r,t,n){var a={version:"0.1.0",type:"Series",name:e,alias:r,aggregate:t,expression:n,display:t+"("+e+")"};return a}function BIMetaModel(){function e(e){if(e&&!(e.length<1)){o=Object.keys(e[0]);for(var n=0,s=0;s<e.length;++s){var c=e[s];if(o.forEach(function(e){a.metadata[e]||(a.metadata[e]={samples:[]}),a.metadata[e].samples.length<i&&a.metadata[e].samples.indexOf(c[e])<0&&(a.metadata[e].samples.push(c[e]),a.metadata[e].samples.length==i&&n++)}),n==o.length)break}o.forEach(function(e){var n,i=a.metadata[e].samples;2==i.length?n=40:i.forEach(function(e){n=r(e)?t(parseFloat(e))?20>n?n:20:10>n?n:10:0}),a.metadata[e].type=u[n]||"String"}),console.log("data _bimetamodel.metadata: ",a.metadata)}}function r(e){var r=!Array.isArray(e)&&!isNaN(parseFloat(e))&&isFinite(e);return r}function t(e){var r=e===+e&&e===(0|e);return r}var n,a={version:"0.1.0"};a.data=function(r){return arguments.length?(n=r,e(n),a):n};var i=5;a.sampleSize=function(e){return arguments.length?(e>0&&100>=e&&(i=e),a):i};var o=[];a.keys=function(){return o},a.metadata={};var u={0:"String",10:"Decimal",20:"Integer",30:"Date",40:"Boolean"};return a}function BIModel(e){function r(e,t,n){Array.isArray(e)&&e.forEach(function(e){t.forEach(function(r){e[r.alias]=parseFloat(e[r.alias].toFixed(n))}),e.children&&r(e.children,t,n)})}function t(e,r){var t="*"==e?"All":e.replace(/ /g,"_").replace(/-/g,"_").replace(/&/g,"_").replace(/@/g,"_");return r?"__S_"+r+"_"+t:"__C_"+t}function n(e,r){var t=e.map(function(e){return e[r]});t.sort(function(e,r){return e==r?0:r>e?-1:1});var n={},a=0;return t.forEach(function(e,r){"undefined"==typeof n[e]&&(n[e]=a,a++)}),n}var a={version:"0.1.0"},i=e||{COLUMN:biquery.column,COUNT:biquery.count,AVG:biquery.average,SUM:biquery.sum,ABSSUM:biquery.abssum},o=[];a.category=function(e,r){if(!arguments.length)return o;if(r){var n=i[r];if(!n)throw new Error("Aggregate function is not found: "+r);var u=t(e,r),s=n(e,u)}else var u=t(e),s=i.COLUMN(e,u);return o.push(new Category(e,u,r,s)),a};var u=[];a.series=function(e,r){if(!arguments.length)return u;r||(r="COUNT");var n=i[r];if(!n)throw new Error("Aggregate function is not found: "+r);var o=t(e,r),s=n(e,o);return u.push(new Series(e,o,r,s)),a},a.getSeriesByName=function(e){var r=u.filter(function(r){return r.name==e});return r?r[0]:void 0},a.seriesDisplayToIndexMap=function(){var e={};return u.forEach(function(r,t){e[r.display]=t}),e};var s=4;a.decimalPlace=function(e){return arguments.length?(e>=0&&(s=e),a):s};var c;a.metaModel=function(e){return arguments.length?(c=e,a):c};var l={pie:"pie",line:"line",map:"map"};a.map=function(e,r){var t=r||"Location";return g(l.pie,function(r,n,a){if(c.keys().indexOf(t)<0)return void console.log("Location column ["+t+"] is not found in the data.");var i={};r.forEach(function(e){var r=e[t];r&&(i[r]||(i[r]=[])).push(e)});var s=Object.keys(i),g={};return s.forEach(function(r){var t=f(i[r],n,a);e[r]||console.log("geo location is not found for "+r),g[r]={chartType:l.pie,data:t,category:o,series:u,location:e[r]||{Latitude:0,Longitude:0}}}),g})},a.line=function(){return g(l.line,function(e,r,t){r.length>2&&console.log("More than two categories are detected, only the first two will be used.");var n=biquery.selectWithSeriesAndCategory(e,t,r.filter(function(e,r){return 1>r}));if(r.length>=2){var a=biquery.selectWithSeriesAndCategory(e,t,r.filter(function(e,r){return 2>r}));Array.prototype.push.apply(n,a)}return n})};var f=function(e,r,t){function n(e,r,t,n,a,i){var o=biquery.selectWithSeriesAndCategory(t,n,a);o.forEach(function(e){var t=[],n=[];a.forEach(function(r){t.push(e[r.alias]),n.push([r.alias,e[r.alias]])}),e.__ids__=t,r[n]=e;var o=[];i.forEach(function(r){o.push([r.alias,e[r.alias]])});var u=r[o];u&&(u.children||(u.children=[])).push(e)}),0==i.length&&Array.prototype.push.apply(e,o)}var a=[],i={},o=[],u=[];return r.forEach(function(r){o.push(r),n(a,i,e,t,o,u),u.push(r)}),a};a.pie=function(){return g(l.pie,f)};var g=function(e,t){if(0==u.length&&0==o.length)return{chartType:e,data:[],category:[],series:[]};0==u.length&&a.series(o[0].name,"COUNT");var i=[];return 0==o.length?(a.category(u[0].name),i=biquery.selectWithSeries(c.data(),u)):i=t(c.data(),o,u),r(i,u,s),o.forEach(function(e){var r=n(c.data(),e.name);e.values(r)}),{chartType:e||l.pie,data:i,category:o,series:u}};return a}BIMetaModel.isDate=function(e){return"Date"==e},BIMetaModel.typeAbbreviation={String:"S",Decimal:"N",Integer:"I",Date:"D",Boolean:"B"},BIModel.emptyCategory={values:function(){return[]}},BIModel.emptySeries={alias:""};