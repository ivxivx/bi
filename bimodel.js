function Category(e,t,n,r,a){var o={version:"0.1.0",type:"Category",name:e,alias:t,aggregate:n,expression:r,display:n?n+"("+e+")":e,auto:a},i={};return o.values=function(e){return arguments.length?(i=e,o):i},o}function Series(e,t,n,r,a){var o={version:"0.1.0",type:"Series",name:e,alias:t,aggregate:n,expression:r,display:n+"("+e+")",auto:a};return o}function BIMetaModel(){function e(e){if(e&&!(e.length<1)){i=Object.keys(e[0]);for(var r=0,c=0;c<e.length;++c){var s=e[c];if(i.forEach(function(e){a.metadata[e]||(a.metadata[e]={samples:[]}),a.metadata[e].samples.length<o&&a.metadata[e].samples.indexOf(s[e])<0&&(a.metadata[e].samples.push(s[e]),a.metadata[e].samples.length==o&&r++)}),r==i.length)break}i.forEach(function(e){var r,o=a.metadata[e].samples;2==o.length?r=40:o.forEach(function(e){r=t(e)?n(parseFloat(e))?20>r?r:20:10>r?r:10:0}),a.metadata[e].type=u[r]||"String"}),console.log("data _bimetamodel.metadata: ",a.metadata)}}function t(e){var t=!Array.isArray(e)&&!isNaN(parseFloat(e))&&isFinite(e);return t}function n(e){var t=e===+e&&e===(0|e);return t}var r,a={version:"0.1.0"};a.data=function(t){return arguments.length?(r=t,e(r),a):r};var o=5;a.sampleSize=function(e){return arguments.length?(e>0&&100>=e&&(o=e),a):o};var i=[];a.keys=function(){return i},a.metadata={};var u={0:"String",10:"Decimal",20:"Integer",30:"Date",40:"Boolean"};return a}function BIModel(e){function t(e,n,r){Array.isArray(e)&&e.forEach(function(e){n.forEach(function(t){e[t.alias]=parseFloat(e[t.alias].toFixed(r))}),e.children&&t(e.children,n,r)})}function n(e,t){var n="*"==e?"All":e.replace(/ /g,"_").replace(/-/g,"_").replace(/&/g,"_").replace(/@/g,"_");return t?"__S_"+t+"_"+n:"__C_"+n}function r(e,t){var n=e.map(function(e){return e[t]});n.sort(function(e,t){return e==t?0:t>e?-1:1});var r={},a=0;return n.forEach(function(e,t){"undefined"==typeof r[e]&&(r[e]=a,a++)}),r}var a={version:"0.1.0"},o=e||{COLUMN:biquery.column,COUNT:biquery.count,AVG:biquery.average,SUM:biquery.sum,ABSSUM:biquery.abssum},i=[];a.category=function(e,t){return arguments.length?(u(e,t,!1),a):i};var u=function(e,t,r){if(t){var a=o[t];if(!a)throw new Error("Aggregate function is not found: "+t);var u=n(e,t),c=a(e,u)}else var u=n(e),c=o.COLUMN(e,u);i.push(new Category(e,u,t,c,r))},c=function(){return i.reduce(function(e,t){return e+(t.auto?0:1)},0)},s=[];a.series=function(e,t){return arguments.length?(l(e,t,!1),a):s};var l=function(e,t,r){if(!arguments.length)return s;t||(t="COUNT");var i=o[t];if(!i)throw new Error("Aggregate function is not found: "+t);var u=n(e,t),c=i(e,u);return s.push(new Series(e,u,t,c,r)),a};a.getSeriesByName=function(e){var t=s.filter(function(t){return t.name==e});return t?t[0]:void 0},a.seriesDisplayToIndexMap=function(){var e={};return s.forEach(function(t,n){e[t.display]=n}),e};var f=4;a.decimalPlace=function(e){return arguments.length?(e>=0&&(f=e),a):f};var g;a.metaModel=function(e){return arguments.length?(g=e,a):g};var d={pie:"pie",line:"line",map:"map"},h=function(e,t,n){return[]},p=function(e,t){return biquery.selectWithSeries(e,t)},v=function(e,t,n){function r(e,t,n,r,a,o){var i=biquery.selectWithSeriesAndCategory(n,r,a);i.forEach(function(e){var n=[],r=[];a.forEach(function(t){n.push(e[t.alias]),r.push([t.alias,e[t.alias]])}),e.__ids__=n,t[r]=e;var i=[];o.forEach(function(t){i.push([t.alias,e[t.alias]])});var u=t[i];u&&(u.children||(u.children=[])).push(e)}),0==o.length&&Array.prototype.push.apply(e,i)}var a=[],o={},i=[],u=[];return t.forEach(function(t){i.push(t),r(a,o,e,n,i,u),u.push(t)}),a};a.map=function(e,t){var n=t||"Location",r={};g.data().forEach(function(e){var t=e[n];t&&(r[t]||(r[t]=[])).push(e)});var a=Object.keys(r),o=y(d.pie,function(t,n,o){var u={};return a.forEach(function(t){e[t]||console.log("geo location is not found for "+t);var a=h(r[t],n,o);u[t]={chartType:d.pie,data:a,category:i,series:s,location:e[t]||{Latitude:0,Longitude:0}}}),u},function(t,n){var o={};return a.forEach(function(t){e[t]||console.log("geo location is not found for "+t);var a=p(r[t],n);o[t]={chartType:d.pie,data:a,category:i,series:s,location:e[t]||{Latitude:0,Longitude:0}}}),o},function(t,o,u){if(g.keys().indexOf(n)<0)return void console.log("Location column ["+n+"] is not found in the data.");var c={};return a.forEach(function(t){e[t]||console.log("geo location is not found for "+t);var n=v(r[t],o,u);c[t]={chartType:d.pie,data:n,category:i,series:s,location:e[t]||{Latitude:0,Longitude:0}}}),c});return o},a.line=function(){return y(d.line,h,p,function(e,t,n){t.length>2&&console.log("More than two categories are detected, only the first two will be used.");var r=biquery.selectWithSeriesAndCategory(e,n,t.filter(function(e,t){return 1>t}));if(t.length>=2){var a=biquery.selectWithSeriesAndCategory(e,n,t.filter(function(e,t){return 2>t}));Array.prototype.push.apply(r,a)}return r})},a.pie=function(){return y(d.pie,h,p,v)};var y=function(e,n,a,o){var h;if(0==s.length&&0==i.length){var h=n(g.data(),i,s);return{chartType:e||d.pie,data:h,category:i,series:s}}return 0==s.length&&l(i[0].name,"COUNT",!0),0==i.length&&u(s[0].name,null,!0),h=0==c()?a(g.data(),s):o(g.data(),i,s),t(h,s,f),i.forEach(function(e){var t=r(g.data(),e.name);e.values(t)}),{chartType:e||d.pie,data:h,category:i,series:s}};return a}BIMetaModel.isDate=function(e){return"Date"==e},BIMetaModel.typeAbbreviation={String:"S",Decimal:"N",Integer:"I",Date:"D",Boolean:"B"},BIModel.emptyCategory={values:function(){return[]}},BIModel.emptySeries={alias:""};