function Category(e,t,r,a){var n={version:"0.1.0",type:"Category",name:e,alias:t,aggregate:r,expression:a,display:r?r+"("+e+")":e},i={};return n.values=function(e){return arguments.length?(i=e,n):i},n}function Series(e,t,r,a){var n={version:"0.1.0",type:"Series",name:e,alias:t,aggregate:r,expression:a,display:r+"("+e+")"};return n}function BIMetaModel(){function e(e){if(e&&!(e.length<1)){o=Object.keys(e[0]);for(var a=0,s=0;s<e.length;++s){var l=e[s];if(o.forEach(function(e){n.metadata[e]||(n.metadata[e]={samples:[]}),n.metadata[e].samples.length<i&&n.metadata[e].samples.indexOf(l[e])<0&&(n.metadata[e].samples.push(l[e]),n.metadata[e].samples.length==i&&a++)}),a==o.length)break}o.forEach(function(e){var a,i=n.metadata[e].samples;2==i.length?a=40:i.forEach(function(e){a=t(e)?r(parseFloat(e))?20>a?a:20:10>a?a:10:0}),n.metadata[e].type=u[a]||"String"}),console.log("data _bimetamodel.metadata: ",n.metadata)}}function t(e){var t=!Array.isArray(e)&&!isNaN(parseFloat(e))&&isFinite(e);return t}function r(e){var t=e===+e&&e===(0|e);return t}var a,n={version:"0.1.0"};n.data=function(t){return arguments.length?(a=t,e(a),n):a};var i=5;n.sampleSize=function(e){return arguments.length?(e>0&&100>=e&&(i=e),n):i};var o=[];n.keys=function(){return o},n.metadata={};var u={0:"String",10:"Decimal",20:"Integer",30:"Date",40:"Boolean"};return n}function BIModel(e){function t(e,r,a){e.forEach(function(e){r.forEach(function(t){e[t.alias]=parseFloat(e[t.alias].toFixed(a))}),e.children&&t(e.children,r,a)})}function r(e,t){var r="*"==e?"All":e.replace(/ /g,"_").replace(/-/g,"_").replace(/&/g,"_").replace(/@/g,"_");return t?"__S_"+t+"_"+r:"__C_"+r}function a(e,t){var r=e.map(function(e){return e[t]});r.sort(function(e,t){return e==t?0:t>e?-1:1});var a={},n=0;return r.forEach(function(e,t){"undefined"==typeof a[e]&&(a[e]=n,n++)}),a}var n={version:"0.1.0"},i=e||{COLUMN:biquery.column,COUNT:biquery.count,AVG:biquery.average,SUM:biquery.sum,ABSSUM:biquery.abssum},o=[];n.category=function(e,t){if(!arguments.length)return o;if(t){var a=i[t];if(!a)throw new Error("Aggregate function is not found: "+t);var u=r(e,t),s=a(e,u)}else var u=r(e),s=i.COLUMN(e,u);return o.push(new Category(e,u,t,s)),n};var u=[];n.series=function(e,t){if(!arguments.length)return u;t||(t="COUNT");var a=i[t];if(!a)throw new Error("Aggregate function is not found: "+t);var o=r(e,t),s=a(e,o);return u.push(new Series(e,o,t,s)),n},n.getSeriesByName=function(e){var t=u.filter(function(t){return t.name==e});return t?t[0]:void 0},n.seriesDisplayToIndexMap=function(){var e={};return u.forEach(function(t,r){e[t.display]=r}),e};var s=4;n.decimalPlace=function(e){return arguments.length?(e>=0&&(s=e),n):s};var l;n.data=function(e){return arguments.length?(l=e,n):l},n.nested="nested",n.flat="flat";var c={};return c[n.flat]=function(e,t,r){t.length>2&&console.log("more than two categories are detected, only the first two will be used");var a=biquery.selectWithSeriesAndCategory(e,r,t.filter(function(e,t){return 1>t}));if(t.length>=2){var n=biquery.selectWithSeriesAndCategory(e,r,t.filter(function(e,t){return 2>t}));Array.prototype.push.apply(a,n)}return a},c[n.nested]=function(e,t,r){function a(e,t,r,a,n,i){var o=biquery.selectWithSeriesAndCategory(r,a,n);o.forEach(function(e){var r=[],a=[];n.forEach(function(t){r.push(e[t.alias]),a.push([t.alias,e[t.alias]])}),e.__ids__=r,t[a]=e;var o=[];i.forEach(function(t){o.push([t.alias,e[t.alias]])});var u=t[o];u&&(u.children||(u.children=[])).push(e)}),0==i.length&&Array.prototype.push.apply(e,o)}var n=[],i={},o=[],u=[];return t.forEach(function(t){o.push(t),a(n,i,e,r,o,u),u.push(t)}),n},n.calculate=function(e){if(0==u.length&&0==o.length)return{data:[],category:[],series:[]};0==u.length&&n.series(o[0].name,"COUNT");var r=[];if(0==o.length)n.category(u[0].name),r=biquery.selectWithSeries(l,u);else{var i=c[e]||c[n.nested];r=i(l,o,u)}return o.forEach(function(e){var t=a(l,e.name);e.values(t)}),t(r,u,s),{data:r,category:o,series:u}},n}BIMetaModel.isDate=function(e){return"Date"==e},BIMetaModel.typeAbbreviation={String:"S",Decimal:"N",Integer:"I",Date:"D",Boolean:"B"},BIModel.emptyCategory={values:function(){return[]}},BIModel.emptySeries={alias:""};