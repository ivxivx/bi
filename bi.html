<!doctype html>
<html>
<head>
<title>Data Visualization for Everyone</title>
<meta charset=utf-8 />
<link rel=stylesheet type=text/css href=https://cdnjs.cloudflare.com/ajax/libs/dragula/3.7.0/dragula.min.css>
<style type=text/css>body,html{width:100%;height:100%;margin:0}#container{width:calc(100% - 20px);height:auto;font-family:Veranda;background:#eef;padding:10px;overflow:hidden;display:table}#configuration{display:table-cell;width:200px;height:auto;border-right:1px solid grey}#chartType{margin:3px}#chartType select{width:190px}#field{min-height:calc(100% - 200px);height:500px;overflow-y:auto}.div-field{display:inline-block;width:170px;background:#ffc;border:1px solid #ccc;margin:3px}.field-text{display:inline-block}.field-type-text{display:inline-block;float:right;font-family:Consolas;cursor:pointer}.field-display{display:inline-block}#main{display:table-cell;width:calc(100% - 220px);min-height:calc(100% - 160px);height:auto;left:220px}#variable{width:auto;height:50px}#variable #category{width:auto;height:25px;background:#efe}#variable #series{width:auto;height:25px;background:#efe;border-top:1px solid black;margin:-1px 0 0 0}#variable #category:empty:not(:focus):before{content:attr(placeholder);color:#ccc}#variable #series:empty:not(:focus):before{content:attr(placeholder);color:#ccc}.variable-selected{width:auto}.chart{width:400px;height:calc(100% - 50px);height:400px;display:table-cell;border:1px solid grey}.chart-description{font-family:consolas;font-size:12px;color:#666}#rawdata{width:100%;height:200px;border-top:1px solid grey;overflow:auto}#rawdatatable{width:100%}#fieldSetting{width:200px;height:auto;margin:auto;background:#ccf;line-height:200%}#fieldSetting *{width:180px;margin:auto}#fieldSetting button{width:90px;margin:0 auto 10px}.bichart-tip{line-height:1;font-weight:bold;padding:12px;background:rgba(0,0,0,0.8);color:#fff;border-radius:2px}.bichart-tip:after{box-sizing:border-box;display:inline;font-size:10px;width:100%;line-height:1;color:rgba(0,0,0,0.8);content:"\25BC";position:absolute;text-align:center}.bichart-tip.n:after{margin:-1px 0 0 0;top:100%;left:0}.bichart-table-column-3{width:100px}svg{overflow:visible}.bichart-line-axis path,.bichart-line-axis line{fill:none;stroke:#000;shape-rendering:crispEdges}.bichart-line-line{fill:none;stroke:steelblue;stroke-width:1.5px}</style>
</head>
<body>
<div id=container>
<div id=configuration>
<div id=field class=dnd-container></div>
</div>
<div id=main>
<div id=variable>
<div id=category class=dnd-container placeholder="drag categories to here"></div>
<div id=series class=dnd-container placeholder="drag series to here"></div>
</div>
<div>
<table>
<tr>
<td><div class=chart-description>Pie Chart<br/>caregories: any number<br/>series: up to 2<br/>(try negative data)</div></td>
<td><div class=chart-description>Line Chart<br/>categories: up to 2<br/>series: any number<br/>(try multiple series)</div></td>
</tr>
<tr>
<td><div class="piechart chart"></div></td>
<td><div class="linechart chart"></div></td>
</tr>
<tr>
<td><div class="tablechart chart">coming soon</div></td>
<td></td>
</tr>
</table>
</div>
</div>
</div>
<div id=fieldSetting style=display:none>
<div>Field Settings</div>
<div>
<select id=fieldTypeSelect class=field-type>
<option value=Boolean>Boolean</option>
<option value=Date>Date</option>
<option value=Decimal>Decimal</option>
<option value=Integer>Integer</option>
<option value=String>String</option>
</select>
</div>
<div>
<select id=fieldAggregateSelect class=field-aggregate>
<option value=COUNT>Count</option>
<option value=AVG>Average</option>
<option value=SUM>Sum</option>
</select>
</div>
<div>
<button id=fieldSettingButtonOK onclick=hideFieldSetting(true)>OK</button><button id=fieldSettingButtonCancel onclick=hideFieldSetting(false)>Cancel</button>
</div>
<div><input id=fieldSettingId type="hidden"/><input id=fieldSettingType type="hidden"/><input id=fieldSettingAggregate type="hidden"/></div>
</div>
<footer>
<script src=https://cdnjs.cloudflare.com/ajax/libs/dragula/3.7.0/dragula.min.js></script>
<script src=https://cdn.jsdelivr.net/alasql/0.2/alasql.min.js></script>
<script src=https://d3js.org/d3.v3.min.js></script>
<script src=https://d3js.org/queue.v1.min.js></script>
<script src=d3.tip.v0.6.3.js type=text/javascript></script>
<script src=bilayout.js type=text/javascript></script>
<script src=biquery.js type=text/javascript></script>
<script src=bimodel.js type=text/javascript></script>
<script src=bichart.js type=text/javascript></script>
<script>
console.log = function() {}
if(!String.format){String.format=function(e,a){var d=e;for(var b=0;b<a.length;b++){var c=new RegExp("\\{"+b+"\\}","gi");d=d.replace(c,a[b])}return d}}function showFieldSetting(b,a){return false;var e=document.querySelector("#fieldSetting");e.style.position="absolute";e.style.display="";e.style.left=b.pageX+"px";e.style.top=b.pageY+"px";var d=e.querySelector("#fieldSettingId");d.value=a.id;var c=e.querySelector("#fieldSettingType");c.value=a.dataset.fieldType;document.querySelector('#fieldTypeSelect [value="'+c.value+'"]').selected=true}function hideFieldSetting(a){if(a){var e=document.querySelector("#fieldSettingId");var c=document.querySelector("#"+e.value);var b=document.querySelector("#fieldTypeSelect").value;c.textContent=BIMetaModel.typeAbbreviation[b];c.dataset.fieldType=b}var d=document.querySelector("#fieldSetting");d.style.display="none"}console.log("loading data");queue().defer(d3.csv,"abc.csv").await(function(e,g){if(e){console.log(e)}else{console.log("data loaded");if(g.length==0){return}var f={top:20,right:20,bottom:30,left:80};var c=bichart.canvas(".piechart",f);var b=bichart.chart(c);var d=bichart.canvas(".linechart",f);var a=bichart.chart(d);var h=new BIMetaModel();h.data(g);d3.select("#field").selectAll("div").data(h.keys()).enter().append("div").attr("class","div-field").html(function(l,k){var j=h.metadata[l].type;return String.format("<div class='field-text'>{0}</div><div id='fieldTypeText{1}' class='field-type-text' data-field-name='{0}' data-field-type='{2}' title='{2}' onclick=\"showFieldSetting(event,this);\">{3}</div><div class='field-display' style='display:none'></div>",[l,k,j,BIMetaModel.typeAbbreviation[j]])});dragula([].slice.call(document.querySelectorAll(".dnd-container")),{isContainer:function(i){return i.classList.contains("dnd-container")},copy:function(i,j){return j===document.querySelector("#field")},accepts:function(i,j){return true},copy:false,copySortSource:true,revertOnSpill:true,removeOnSpill:false}).on("dragend",function(i){}).on("drop",function(k,p,i){var m=[].slice.call(document.querySelector("#category").children);var r=[].slice.call(document.querySelector("#series").children);var q=new BIModel();m.forEach(function(w){var v=w.querySelector(".field-text");q.category(v.textContent)});r.forEach(function(w){var v=w.querySelector(".field-text");q.series(v.textContent,"SUM")});if(p==document.querySelector("#category")||p==document.querySelector("#series")){k.classList.add("variable-selected");var t=k.querySelector(".field-type-text");t.style.display="none";if(p==document.querySelector("#series")){var l=k.querySelector(".field-text");l.style.display="none";var j=l.textContent;var s=k.querySelector(".field-display");s.style.display="";s.dataset.fieldName=t.dataset.fieldName;s.dataset.fieldType=t.dataset.fieldType;var o=q.getSeriesByName(j);if(o){s.dataset.fileAggregate=o.aggregate;s.textContent=o.display}}}else{if(i==document.querySelector("#category")||i==document.querySelector("#series")){k.classList.remove("variable-selected");k.querySelector(".field-text").style.display="";k.querySelector(".field-type-text").style.display="";k.querySelector(".field-display").style.display="none"}}q.data(h.data()).decimalPlace(2);Array.prototype.slice.call(document.querySelectorAll(".field-type-text")).forEach(function(w){var v=w.dataset.fieldName;var x=w.dataset.fieldType;h.metadata[v].type=x});var n=b.pie();n.baseRadius(30).width(20).arcGap(0.01).negativeRatio(1.2).animationMode(1);if(q.series().length<=2){b.draw(h,q.calculate(q.nested))}var u=a.line();a.draw(h,q.calculate(q.flat))})}});</script>
</footer>
</body>
</html>
